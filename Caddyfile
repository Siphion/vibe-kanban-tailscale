{
	order authenticate before respond
	order authorize before basicauth

	security {
		local identity store localdb {
			realm local
			path {$HOME}/.local/caddy/users.json
		}

		authentication portal myportal {
			crypto default token lifetime 86400
			crypto key sign-verify {env.JWT_SHARED_KEY}
			enable identity store localdb
			cookie domain {env.TS_HOSTNAME}
			cookie lifetime 86400
			ui {
				links {
					"Vibe Kanban" / icon "las la-columns"
				}
			}
			transform user {
				match origin local
				action add role authp/user
			}
		}

		authorization policy mypolicy {
			set auth url https://{env.TS_HOSTNAME}/auth/
			allow roles authp/admin authp/user
			crypto key verify {env.JWT_SHARED_KEY}
		}

		authorization policy codepolicy {
			set auth url https://{env.TS_HOSTNAME}:8443/auth/
			allow roles authp/admin authp/user
			crypto key verify {env.JWT_SHARED_KEY}
		}
	}
}

:8443 {
	bind 127.0.0.1

	route /auth* {
		authenticate with myportal
	}

	route /* {
		authorize with mypolicy
		reverse_proxy 127.0.0.1:38100
	}
}

:8444 {
	bind 127.0.0.1

	route /auth* {
		authenticate with myportal
	}

	route /* {
		authorize with codepolicy
		reverse_proxy 127.0.0.1:38200
	}
}
